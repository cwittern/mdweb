{% extends "laybase.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "_macros.html" as macros %}


{% block subhead %}

<header class="jumbotron subhead" id="overview">
  <div class="container">
    <h1>{{sr.head}}</h1>
    <p>
    {{_('Searched for')}}
    {{key}}.
    {% if filter %}
    {{_('Filtered by: ')}}
    {{filter}}
    {% endif %}
    {{_('Found')}} 
    {{sr.total}},
    {{_('showing %d to %d.' % (start+1, n))}}
    <span  class="pull-right">　<a href="bytext?query={{key}}">by text</a></span>
    {% if filter %}
    <span  class="pull-right">　
    <a href="search?query={{key}}">
      {{_('release filter')}}
    </a>
    </span>
    {% endif %}
    </p>
  </div>
</header>


{% endblock subhead %}



{% block body %}

<div>
    <table>
      {% for item in sr.list %}
      {% set it_txtid, it_juan = item[1].split(':')[0].split('_') %}
      {% set it_page = item[1].split(':')[1] %}
      {% set it_line = item[1].split(':')[2] %}
      {% set it_rest = item[1].split(':')[2] %}
      {% set vstmp = item[1].split('\t')[1] %}
      {% set vs = vstmp %}
      <tr>
<!-- http://localhost:5000/text/ZB6q0003/003#0221a -->
<!-- ZB1a0068:007-352:2:6 -->
<td class="text-left">{{it_txtid}}</td>
	<td class="text-left"><a href="{{url_for('main.showtext', id=it_txtid, juan=it_juan, query=key, _anchor=it_juan+'-'+it_page)}}" title="{{it_txtid}} {{item[2]['TITLE']}}">{{item[2]['TITLE'].decode('utf-8')|truncate(12, true)}}, {{it_juan.lstrip('0')}}, {{it_page.lstrip('0')}}</a></td>
<td>{{item[0]|safe}}</td> 
<td class="text-left">{{item[3]|safe}}</td>
<td class="text-right">
{% if vs == "n" %}
<span title="{{vs}}">　(夾住)</span>
{% elif vs %}
<span title="{{vs}}">　(異本)</span>
{% endif %}
</td>
      </tr>
    {% endfor %}
    </table>
{% if sr.total > 20 %}
<div class="pagination">
    {{ macros.pagination_widget(pagination, '.searchtext', query=key, filter=filter, type=tpe, count=count, sort=sort) }}
</div>
{% endif %}

</div>


{% endblock %}

{% block sidebar %}
<div id="sort"><h4>Sort</h4></div>
<ul>
  <li><a href="search?query={{key}}{% if filter %}&amp;filter={{filter}}{% endif %}&amp;sort=+txtid">By text number</a></li>
  <li><a href="search?query={{key}}{% if filter %}&amp;filter={{filter}}{% endif %}&amp;sort=-date">By text date</a></li>
  <li><a href="search?query={{key}}{% if filter %}&amp;filter={{filter}}{% endif %}&amp;sort=+term">By search term</a></li>
  <li><a href="search?query={{key}}{% if filter %}&amp;filter={{filter}}{% endif %}&amp;sort=+pre">By preceding characters</a></li>
</ul>  
{% if session['user'] %}
<div id="filter"><h4>特別 (Filter)</h4></div>
<hr/>
{% endif %}
<div id="dyn"><h4>朝代</h4></div>
<hr/>
<div id="bu"><h4>部</h4></div>
<hr/>
<div id="lei"><h4>部／類</h4></div>
<hr/>
<div id="texts"><h4>文獻</h4></div>
{% endblock sidebar %}

{% block closingscript %}
<script>
(function($) {
    $(document).ready(function() {
            $.ajax({
                type: 'GET',
                url: '/getfacets?query={{key}}&type=FILTER&cnt=10',
                dataType: 'html',
                success: function(html, textStatus) {
                    $('#filter').append(html);
                },
                error: function(xhr, textStatus, errorThrown) {
                    alert('An error occurred! ' + ( errorThrown ? errorThrown : xhr.status ));
                }
        });
            $.ajax({
                type: 'GET',
                url: '/getfacets?query={{key}}&type=DYNASTY&cnt=4',
                dataType: 'html',
                success: function(html, textStatus) {
                    $('#dyn').append(html);
                },
                error: function(xhr, textStatus, errorThrown) {
                    alert('An error occurred! ' + ( errorThrown ? errorThrown : xhr.status ));
                }
        });
            $.ajax({
                type: 'GET',
                url: '/getfacets?query={{key}}&len=3&cnt=6',
                dataType: 'html',
                success: function(html, textStatus) {
                    $('#bu').append(html);
                },
                error: function(xhr, textStatus, errorThrown) {
                    alert('An error occurred! ' + ( errorThrown ? errorThrown : xhr.status ));
                }
        });
            $.ajax({
                type: 'GET',
                url: '/getfacets?query={{key}}&len=4&cnt=6',
                dataType: 'html',
                success: function(html, textStatus) {
                    $('#lei').append(html);
                },
                error: function(xhr, textStatus, errorThrown) {
                    alert('An error occurred! ' + ( errorThrown ? errorThrown : xhr.status ));
                }
        });
            $.ajax({
                type: 'GET',
                url: '/getfacets?query={{key}}&len=8&cnt=6',
                dataType: 'html',
                success: function(html, textStatus) {
                    $('#texts').append(html);
                },
                error: function(xhr, textStatus, errorThrown) {
                    alert('An error occurred! ' + ( errorThrown ? errorThrown : xhr.status ));
                }
        });
    });
})(jQuery);


</script>

{% endblock %}
